{% extends 'clientes/base.html' %}
{% load static %}

{% block title %}{{ titulo }} - FIT{% endblock %}

{% block content %}
<div class="page-header">
    <h2>{{ titulo }}</h2>
</div>

<div class="table-container">
    {% if piezas_con_calculos %}
        <!-- Búsqueda -->
        <div class="search-container" style="margin-bottom: 20px;">
            <form method="get" class="search-form">
                <input 
                    type="text" 
                    name="busqueda" 
                    value="{{ busqueda }}" 
                    placeholder="Buscar por nombre, número, equipo minero o equipo corte..." 
                    class="form-control"
                    style="display: inline-block; width: 400px; margin-right: 10px;"
                >
                <button type="submit" class="btn btn-primary">Buscar</button>
                {% if busqueda %}
                    <a href="{% url 'gerencia_le_stage:control_produccion_piezas_corte' %}" class="btn btn-secondary">Limpiar</a>
                {% endif %}
            </form>
        </div>

        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Equipo Minero</th>
                    <th>Equipo Corte</th>
                    <th>Kilos Industria</th>
                    <th>Costos Industrialización</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for item in piezas_con_calculos %}
                <tr>
                    <td>{{ item.pieza.id }}</td>
                    <td>{{ item.pieza.nombre_piedra|default:"-" }}</td>
                    <td>{{ item.pieza.equipo_minero|default:"-" }}</td>
                    <td>{{ item.pieza.equipo_corte|default:"-" }}</td>
                    <td>{{ item.pieza.kilos_recepcion_industria|floatformat:2 }}</td>
                    <td>
                        <span 
                            class="costos-industrializacion" 
                            style="cursor: help; text-decoration: underline; text-decoration-style: dotted;"
                            title="Costo Tallado: ${{ item.costo_tallado|floatformat:2 }}&#10;Costo Pulido: ${{ item.costo_pulido|floatformat:2 }}&#10;Extra Carlos: ${{ item.extra_carlos_decimal|floatformat:2 }}"
                            data-bs-toggle="tooltip" 
                            data-bs-placement="top"
                        >
                            ${{ item.costos_industrializacion|floatformat:2 }}
                        </span>
                    </td>
                    <td>
                        <a href="{% url 'gerencia_le_stage:detalle_pieza_corte' item.pieza.id %}" class="btn btn-sm btn-info">Ver</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <!-- Paginación -->
        {% if piezas.has_other_pages %}
        <div class="pagination" style="margin-top: 20px; display: flex; justify-content: center; align-items: center; gap: 10px;">
            {% if piezas.has_previous %}
                <a href="?page={{ piezas.previous_page_number }}{% if busqueda %}&busqueda={{ busqueda|urlencode }}{% endif %}" class="btn btn-sm btn-secondary">« Anterior</a>
            {% else %}
                <span class="btn btn-sm btn-secondary disabled">« Anterior</span>
            {% endif %}
            
            <span class="pagination-info" style="padding: 5px 15px;">
                Página {{ piezas.number }} de {{ piezas.paginator.num_pages }}
                {% if piezas.paginator.count %}
                    ({{ piezas.paginator.count }} registro{{ piezas.paginator.count|pluralize }})
                {% endif %}
            </span>
            
            {% if piezas.has_next %}
                <a href="?page={{ piezas.next_page_number }}{% if busqueda %}&busqueda={{ busqueda|urlencode }}{% endif %}" class="btn btn-sm btn-secondary">Siguiente »</a>
            {% else %}
                <span class="btn btn-sm btn-secondary disabled">Siguiente »</span>
            {% endif %}
        </div>
        {% endif %}
    {% else %}
        <div class="empty-state">
            <p>No se encontraron piezas de corte.</p>
        </div>
    {% endif %}
</div>

<style>
.costos-industrializacion:hover {
    color: #0056b3;
    font-weight: bold;
}
</style>

<script>
// Inicializar tooltips de Bootstrap si está disponible
document.addEventListener('DOMContentLoaded', function() {
    // Si Bootstrap está disponible, usar tooltips nativos
    if (typeof bootstrap !== 'undefined') {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl, {
                html: true
            });
        });
    } else {
        // Fallback: usar tooltips HTML nativos
        var costosElements = document.querySelectorAll('.costos-industrializacion');
        costosElements.forEach(function(el) {
            el.addEventListener('mouseenter', function(e) {
                var title = this.getAttribute('title');
                if (title) {
                    var tooltip = document.createElement('div');
                    tooltip.className = 'custom-tooltip';
                    tooltip.style.cssText = 'position: absolute; background: #333; color: white; padding: 8px 12px; border-radius: 4px; font-size: 12px; z-index: 1000; pointer-events: none; white-space: pre-line; box-shadow: 0 2px 8px rgba(0,0,0,0.3);';
                    tooltip.textContent = title.replace(/&#10;/g, '\n');
                    document.body.appendChild(tooltip);
                    
                    var rect = this.getBoundingClientRect();
                    tooltip.style.left = (rect.left + rect.width / 2 - tooltip.offsetWidth / 2) + 'px';
                    tooltip.style.top = (rect.top - tooltip.offsetHeight - 10) + 'px';
                    
                    this._tooltip = tooltip;
                }
            });
            
            el.addEventListener('mouseleave', function() {
                if (this._tooltip) {
                    document.body.removeChild(this._tooltip);
                    this._tooltip = null;
                }
            });
        });
    }
});
</script>
{% endblock %}

