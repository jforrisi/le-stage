{% extends 'clientes/base.html' %}
{% load static %}

{% block title %}{{ titulo }} - FIT{% endblock %}

{% block content %}
<div class="page-header">
    <h2>{{ titulo }}</h2>
    <a href="{% url 'ventas_ingreso:lista_ventas' %}" class="btn btn-secondary">Volver a Lista</a>
</div>

<div class="form-container">
    <form method="post" id="venta-form" class="form">
        {% csrf_token %}
        
        <!-- Errores generales del formulario -->
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {{ form.non_field_errors }}
            </div>
        {% endif %}
        
        <!-- Mostrar errores de validaci칩n -->
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
        
        <!-- CABEZAL COMPACTO -->
        <div class="form-section compact-header">
            <style>
                .compact-header .form-row-compact {
                    display: flex;
                    gap: 10px;
                    margin-bottom: 8px;
                    align-items: flex-end;
                }
                .compact-header .form-group-compact {
                    flex: 1;
                    margin-bottom: 0;
                }
                .compact-header .form-group-compact label {
                    font-size: 0.85rem;
                    margin-bottom: 2px;
                    font-weight: 500;
                }
                .compact-header .form-group-compact input,
                .compact-header .form-group-compact select,
                .compact-header .form-group-compact textarea {
                    font-size: 0.9rem;
                    padding: 4px 8px;
                    height: auto;
                }
                .compact-header .form-group-small {
                    flex: 0 0 auto;
                    width: 120px;
                }
                .compact-header .form-group-medium {
                    flex: 0 0 auto;
                    width: 150px;
                }
                .compact-header .form-group-large {
                    flex: 0 0 auto;
                    width: 250px;
                }
                .compact-header .form-group-large {
                    flex: 0 0 auto;
                    width: 250px;
                }
                .autocomplete-container {
                    position: relative;
                }
                .autocomplete-results {
                    position: absolute;
                    top: 100%;
                    left: 0;
                    right: 0;
                    background: white;
                    border: 1px solid #ccc;
                    border-top: none;
                    max-height: 200px;
                    overflow-y: auto;
                    z-index: 1000;
                    display: none;
                }
                .autocomplete-results.show {
                    display: block;
                }
                .autocomplete-item {
                    padding: 8px;
                    cursor: pointer;
                    border-bottom: 1px solid #eee;
                }
                .autocomplete-item:hover {
                    background-color: #f0f0f0;
                }
                .autocomplete-item.selected {
                    background-color: #007bff;
                    color: white;
                }
            </style>
            
            <!-- L칤nea 0: Tipo de Venta -->
            <div class="form-row-compact" style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #dee2e6;">
                <div class="form-group-compact form-group-medium">
                    <label for="{{ form.tipo_venta.id_for_label }}">Tipo de Venta *</label>
                    {{ form.tipo_venta }}
                    {% if form.tipo_venta.errors %}<div class="error-message" style="font-size: 0.75rem;">{{ form.tipo_venta.errors }}</div>{% endif %}
                </div>
            </div>
            
            <!-- L칤nea 1: Cliente -->
            <div class="form-row-compact">
                <div class="form-group-compact form-group-large">
                    <label>Cliente *</label>
                    <div class="autocomplete-container">
                        {{ form.id_cliente }}
                        <input type="text" id="cliente-search" class="form-control form-control-sm" placeholder="Escriba para buscar cliente... (F2)" autocomplete="off">
                        <div class="autocomplete-results" id="cliente-results"></div>
                    </div>
                    {% if form.id_cliente.errors %}<div class="error-message" style="font-size: 0.75rem;">{{ form.id_cliente.errors }}</div>{% endif %}
                </div>
            </div>
            
            <!-- L칤nea 2: Fecha, Tipo, Serie, N칰mero -->
            <div class="form-row-compact">
                <div class="form-group-compact form-group-medium">
                    <label for="{{ form.fecha_documento.id_for_label }}">Fecha *</label>
                    {{ form.fecha_documento }}
                    {% if form.fecha_documento.errors %}<div class="error-message" style="font-size: 0.75rem;">{{ form.fecha_documento.errors }}</div>{% endif %}
                </div>
                <div class="form-group-compact form-group-large">
                    <label for="{{ form.tipo_documento.id_for_label }}">Tipo *</label>
                    {{ form.tipo_documento }}
                    {% if form.tipo_documento.errors %}<div class="error-message" style="font-size: 0.75rem;">{{ form.tipo_documento.errors }}</div>{% endif %}
                </div>
                <div class="form-group-compact form-group-small">
                    <label for="{{ form.serie_documento.id_for_label }}">Serie</label>
                    {{ form.serie_documento }}
                    {% if form.serie_documento.errors %}<div class="error-message" style="font-size: 0.75rem;">{{ form.serie_documento.errors }}</div>{% endif %}
                </div>
                <div class="form-group-compact form-group-medium">
                    <label for="{{ form.numero_documento.id_for_label }}">N칰mero *</label>
                    {{ form.numero_documento }}
                    {% if form.numero_documento.errors %}<div class="error-message" style="font-size: 0.75rem;">{{ form.numero_documento.errors }}</div>{% endif %}
                </div>
            </div>
            
            <!-- L칤nea 3: Moneda, Forma Pago, y a la derecha: Disponibilidad (contado) o Plazo + Fecha Vto (cr칠dito) -->
            <div class="form-row-compact" style="justify-content: space-between;">
                <div style="display: flex; gap: 10px; flex: 1;">
                    <div class="form-group-compact form-group-small">
                        <label for="{{ form.moneda.id_for_label }}">Moneda *</label>
                        {{ form.moneda }}
                        {% if form.moneda.errors %}<div class="error-message" style="font-size: 0.75rem;">{{ form.moneda.errors }}</div>{% endif %}
                    </div>
                    <div class="form-group-compact form-group-medium">
                        <label for="{{ form.forma_pago.id_for_label }}">Forma Pago *</label>
                        {{ form.forma_pago }}
                        {% if form.forma_pago.errors %}<div class="error-message" style="font-size: 0.75rem;">{{ form.forma_pago.errors }}</div>{% endif %}
                    </div>
                </div>
                <div style="display: flex; gap: 10px; align-items: flex-end;">
                    <div class="form-group-compact" id="disponibilidad-group" style="display: none; width: 350px; min-width: 350px;">
                        <label for="{{ form.disponibilidad.id_for_label }}">Disponibilidad *</label>
                        {{ form.disponibilidad }}
                        {% if form.disponibilidad.errors %}<div class="error-message" style="font-size: 0.75rem;">{{ form.disponibilidad.errors }}</div>{% endif %}
                    </div>
                    <div class="form-group-compact form-group-medium" id="plazo-group" style="display: none;">
                        <label for="{{ form.plazo.id_for_label }}">Plazo *</label>
                        {{ form.plazo }}
                        {% if form.plazo.errors %}<div class="error-message" style="font-size: 0.75rem;">{{ form.plazo.errors }}</div>{% endif %}
                    </div>
                    <div class="form-group-compact form-group-small" id="fecha-vencimiento-group" style="display: none;">
                        <label for="{{ form.fecha_vencimiento.id_for_label }}">Fecha Vto.</label>
                        {{ form.fecha_vencimiento }}
                        {% if form.fecha_vencimiento.errors %}<div class="error-message" style="font-size: 0.75rem;">{{ form.fecha_vencimiento.errors }}</div>{% endif %}
                    </div>
                </div>
            </div>
            
            <!-- L칤nea 3.5: IVA Incl. y Observaciones (solo para CONVENCIONAL) -->
            <div class="form-row-compact" id="precio-iva-inc-row">
                <div class="form-group-compact form-group-small">
                    <label for="{{ form.precio_iva_inc.id_for_label }}">IVA Incl. *</label>
                    {{ form.precio_iva_inc }}
                    <small class="form-text" id="precio-iva-inc-help" style="font-size: 0.7rem; display: block; color: #6c757d;">En ventas, los precios siempre incluyen IVA</small>
                    {% if form.precio_iva_inc.errors %}<div class="error-message" style="font-size: 0.75rem;">{{ form.precio_iva_inc.errors }}</div>{% endif %}
                </div>
                <div class="form-group-compact form-group-large" style="flex: 1;">
                    <label for="{{ form.observaciones.id_for_label }}">Observaciones</label>
                    {{ form.observaciones }}
                    {% if form.observaciones.errors %}<div class="error-message" style="font-size: 0.75rem;">{{ form.observaciones.errors }}</div>{% endif %}
                </div>
            </div>
            
            <!-- Totales Manuales (solo para SIMPLIFICADA) -->
            <div class="form-row-compact" id="totales-manuales-row" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 2px solid #dee2e6; align-items: flex-start;">
                <div class="form-group-compact form-group-medium" style="flex: 1; min-width: 200px;">
                    <label for="{{ form.sub_total.id_for_label }}">Sub Total *</label>
                    {{ form.sub_total }}
                    {% if form.sub_total.errors %}<div class="error-message" style="font-size: 0.75rem;">{{ form.sub_total.errors }}</div>{% endif %}
                </div>
                <div class="form-group-compact form-group-medium" style="flex: 1; min-width: 200px;">
                    <label for="{{ form.iva.id_for_label }}">IVA *</label>
                    {{ form.iva }}
                    <small class="form-text text-muted" id="iva-help-text" style="font-size: 0.7rem; display: block; margin-top: 2px;">M치ximo: 22% del Sub Total</small>
                    {% if form.iva.errors %}<div class="error-message" style="font-size: 0.75rem;">{{ form.iva.errors }}</div>{% endif %}
                </div>
                <div class="form-group-compact form-group-medium" style="flex: 1; min-width: 200px;">
                    <label for="{{ form.importe_total.id_for_label }}">Importe Total *</label>
                    {{ form.importe_total }}
                    <small class="form-text text-muted" style="font-size: 0.7rem; display: block; margin-top: 2px;">Se calcula autom치ticamente: Sub Total + IVA</small>
                    {% if form.importe_total.errors %}<div class="error-message" style="font-size: 0.75rem;">{{ form.importe_total.errors }}</div>{% endif %}
                </div>
            </div>
            
            <!-- Observaciones para SIMPLIFICADA (m치s espacio) -->
            <div class="form-row-compact" id="observaciones-simplificada-row" style="display: none; margin-top: 10px;">
                <div class="form-group-compact form-group-large" style="flex: 1;">
                    <label for="{{ form.observaciones.id_for_label }}">Observaciones</label>
                    {{ form.observaciones }}
                    {% if form.observaciones.errors %}<div class="error-message" style="font-size: 0.75rem;">{{ form.observaciones.errors }}</div>{% endif %}
                </div>
            </div>
        </div>
        
        <!-- L칈NEAS (solo para CONVENCIONAL) -->
        <div class="form-section" id="lineas-section">
            <h3>L칤neas de Venta</h3>
            <div id="lineas-container">
                {{ formset.management_form }}
                <table class="table table-sm table-compact" id="lineas-table" style="font-size: 0.9rem;">
                    <thead>
                        <tr>
                            <th>L칤nea</th>
                            <th>Art칤culo *</th>
                            <th>Cantidad *</th>
                            <th>Precio Original *</th>
                            <th>Descuento (%)</th>
                            <th>Precio Neto</th>
                            <th>Sub Total</th>
                            <th>IVA</th>
                            <th>Total</th>
                            <th>Eliminar</th>
                        </tr>
                    </thead>
                    <tbody id="lineas-tbody">
                        {% for form_linea in formset %}
                        <tr class="linea-row" data-form-index="{{ forloop.counter0 }}">
                            <td>
                                {{ form_linea.linea }}
                                {% if form_linea.linea.errors %}<div class="error-message">{{ form_linea.linea.errors }}</div>{% endif %}
                            </td>
                            <td>
                                {{ form_linea.id_articulo }}
                                {{ form_linea.id }}
                                {% if form_linea.DELETE %}
                                    <div style="display: none;">{{ form_linea.DELETE }}</div>
                                {% endif %}
                                <div class="autocomplete-container" style="position: relative; display: flex; align-items: center; gap: 3px;">
                                    <input type="text" class="form-control form-control-sm articulo-search" placeholder="Presione F2 o click en buscar" autocomplete="off" style="width: 150px;" data-articulo-row="{{ forloop.counter0 }}" data-busqueda-mode="nombre" disabled>
                                    <button type="button" class="btn btn-sm btn-secondary buscar-articulo-btn" style="padding: 2px 8px; font-size: 0.75rem;" title="Buscar art칤culo (F2)">游댌</button>
                                    <button type="button" class="btn btn-sm btn-info toggle-busqueda-btn" style="padding: 2px 6px; font-size: 0.7rem; min-width: 100px;" title="Alternar modo de b칰squeda" data-mode="nombre">Nombre</button>
                                    <div class="autocomplete-results articulo-results" style="display: none;"></div>
                                </div>
                                {% if form_linea.id_articulo.errors %}<div class="error-message" style="font-size: 0.75rem;">{{ form_linea.id_articulo.errors }}</div>{% endif %}
                            </td>
                            <td>
                                {{ form_linea.cantidad }}
                                {% if form_linea.cantidad.errors %}<div class="error-message">{{ form_linea.cantidad.errors }}</div>{% endif %}
                            </td>
                            <td>
                                {{ form_linea.precio_original }}
                                {% if form_linea.precio_original.errors %}<div class="error-message">{{ form_linea.precio_original.errors }}</div>{% endif %}
                            </td>
                            <td>
                                {{ form_linea.descuento }}
                                {% if form_linea.descuento.errors %}<div class="error-message">{{ form_linea.descuento.errors }}</div>{% endif %}
                            </td>
                            <td><span class="precio-neto-display">0.00</span></td>
                            <td><span class="sub-total-display">0.00</span></td>
                            <td><span class="iva-display">0.00</span></td>
                            <td><span class="total-display">0.00</span></td>
                            <td>
                                <button type="button" class="btn btn-sm btn-danger remove-linea-btn">Eliminar</button>
                                {% if form_linea.DELETE %}
                                    <div style="display: none;">{{ form_linea.DELETE }}</div>
                                {% else %}
                                    <input type="checkbox" name="{{ form_linea.prefix }}-DELETE" id="id_{{ form_linea.prefix }}-DELETE" style="display: none;">
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="6" style="text-align: right;"><strong>TOTALES:</strong></td>
                            <td><strong id="total-subtotal">0.00</strong></td>
                            <td><strong id="total-iva">0.00</strong></td>
                            <td><strong id="total-total">0.00</strong></td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
                <button type="button" id="add-linea-btn" class="btn btn-secondary">Agregar L칤nea</button>
            </div>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Guardar Venta</button>
            <a href="{% url 'ventas_ingreso:lista_ventas' %}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>

<!-- Modal para b칰squeda de Clientes -->
<div id="modal-clientes" class="modal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div class="modal-content" style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 800px; border-radius: 5px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>Buscar Cliente</h3>
            <span class="close-modal" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        </div>
        <input type="text" id="modal-cliente-search" class="form-control" placeholder="Escriba para buscar..." autocomplete="off" style="margin-bottom: 15px;">
        <div id="modal-cliente-results" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 3px;">
            <!-- Resultados aqu칤 -->
        </div>
    </div>
</div>

<!-- Modal para b칰squeda de Art칤culos -->
<div id="modal-articulos" class="modal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div class="modal-content" style="background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 800px; border-radius: 5px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>Buscar Art칤culo</h3>
            <span class="close-modal" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        </div>
        <input type="text" id="modal-articulo-search" class="form-control" placeholder="Escriba para buscar..." autocomplete="off" style="margin-bottom: 15px;">
        <div id="modal-articulo-results" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 3px;">
            <!-- Resultados aqu칤 -->
        </div>
    </div>
</div>

<style>
.modal-item {
    padding: 10px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}
.modal-item:hover {
    background-color: #f0f0f0;
}
.modal-item.selected {
    background-color: #007bff;
    color: white;
}
</style>

<script>
// Datos desde el backend
const clientesData = JSON.parse('{{ clientes_data|escapejs }}');

// ========== AUTocompletado de Clientes ==========
let clienteSearchTimeout;
const clienteSearchInput = document.getElementById('cliente-search');
const clienteResultsDiv = document.getElementById('cliente-results');
// Buscar el input hidden - puede tener diferentes IDs dependiendo de Django
let clienteHiddenInput = document.getElementById('id_cliente');
if (!clienteHiddenInput) {
    // Intentar buscar por name
    clienteHiddenInput = document.querySelector('input[name="id_cliente"]');
}
if (!clienteHiddenInput) {
    // Intentar buscar cualquier input hidden dentro del autocomplete-container
    const container = document.querySelector('.autocomplete-container');
    if (container) {
        clienteHiddenInput = container.querySelector('input[type="hidden"]');
    }
}

// Verificar que los elementos existan
if (!clienteSearchInput) {
    console.error('No se encontr칩 el input de b칰squeda de cliente');
}
if (!clienteHiddenInput) {
    console.error('No se encontr칩 el input hidden de cliente');
    console.log('Buscando inputs hidden disponibles:', document.querySelectorAll('input[type="hidden"]'));
} else {
    // Asegurarse de que tenga el ID correcto
    if (clienteHiddenInput.id !== 'id_cliente') {
        clienteHiddenInput.id = 'id_cliente';
        console.log('ID del input hidden corregido a id_cliente');
    }
}
if (!clienteResultsDiv) {
    console.error('No se encontr칩 el div de resultados de cliente');
}

// Cargar cliente actual si existe (en edici칩n)
{% if form.instance.id_cliente %}
    if (clienteSearchInput && clientesData) {
        const clienteActual = clientesData.find(p => p.id == {{ form.instance.id_cliente.id }});
        if (clienteActual) {
            const nombreDisplay = clienteActual.razon || clienteActual.nombre_comercial || 'Sin nombre';
            clienteSearchInput.value = nombreDisplay;
        }
    }
{% endif %}

if (clienteSearchInput) {
    clienteSearchInput.addEventListener('input', function() {
        const query = this.value.trim();
        clearTimeout(clienteSearchTimeout);
        
        if (query.length < 2) {
            if (clienteResultsDiv) {
                clienteResultsDiv.classList.remove('show');
            }
            return;
        }
        
        clienteSearchTimeout = setTimeout(() => {
            fetch(`{% url 'ventas_ingreso:buscar_clientes' %}?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    mostrarResultadosClientes(data.results);
                })
                .catch(error => {
                    console.error('Error buscando clientes:', error);
                });
        }, 300);
    });

    // Event listener para F2 en cliente - abrir popup
    clienteSearchInput.addEventListener('keydown', function(e) {
        if (e.key === 'F2') {
            e.preventDefault();
            console.log('F2 presionado en cliente');
            console.log('clienteHiddenInput:', clienteHiddenInput);
            if (clienteHiddenInput) {
                abrirPopupClientes(clienteSearchInput, clienteHiddenInput);
            } else {
                console.error('No se encontr칩 clienteHiddenInput, intentando buscarlo de nuevo...');
                // Intentar buscar de nuevo
                clienteHiddenInput = document.getElementById('id_cliente') || 
                                   document.querySelector('input[name="id_cliente"]') ||
                                   document.querySelector('.autocomplete-container input[type="hidden"]');
                if (clienteHiddenInput) {
                    console.log('clienteHiddenInput encontrado:', clienteHiddenInput);
                    abrirPopupClientes(clienteSearchInput, clienteHiddenInput);
                } else {
                    console.error('No se pudo encontrar clienteHiddenInput');
                    alert('Error: No se pudo encontrar el campo de cliente. Por favor, recargue la p치gina.');
                }
            }
        }
    });

    // Event listener para cuando el usuario sale del campo (blur) - validar y cargar forma de pago
    clienteSearchInput.addEventListener('blur', function() {
        if (!clienteHiddenInput) {
            return;
        }
        
        const textoEscrito = this.value.trim();
        if (!textoEscrito) {
            // Si est치 vac칤o, limpiar el hidden input
            clienteHiddenInput.value = '';
            return;
        }
        
        // Si ya hay un cliente seleccionado y el texto coincide, no hacer nada
        if (clienteHiddenInput.value) {
            const clienteActual = clientesData.find(p => p.id == clienteHiddenInput.value);
            if (clienteActual) {
                const text = clienteActual.text || '';
                const razon = clienteActual.razon || clienteActual.razon_social || '';
                const nombreComercial = clienteActual.nombre_comercial || '';
                if (text === textoEscrito || razon === textoEscrito || nombreComercial === textoEscrito) {
                    return; // Ya est치 seleccionado correctamente
                }
            }
        }
        
        // Buscar el cliente por el texto escrito
        const clienteEncontrado = clientesData.find(p => {
            const text = p.text || '';
            const razon = p.razon || p.razon_social || '';
            const nombreComercial = p.nombre_comercial || '';
            const textoLower = textoEscrito.toLowerCase();
            
            return text === textoEscrito || 
                   razon === textoEscrito || 
                   nombreComercial === textoEscrito ||
                   (text && text.toLowerCase().includes(textoLower)) ||
                   (razon && razon.toLowerCase().includes(textoLower)) ||
                   (nombreComercial && nombreComercial.toLowerCase().includes(textoLower));
        });
        
        if (clienteEncontrado) {
            // Si se encuentra, seleccionarlo autom치ticamente
            seleccionarCliente(clienteEncontrado);
        } else if (textoEscrito.length >= 2) {
            // Si no se encuentra pero hay texto suficiente, buscar en el servidor
            fetch(`{% url 'ventas_ingreso:buscar_clientes' %}?q=${encodeURIComponent(textoEscrito)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.results && data.results.length > 0) {
                        // Si hay resultados, tomar el primero que coincida exactamente
                        const exacto = data.results.find(p => {
                            const text = p.text || '';
                            const razon = p.razon || p.razon_social || '';
                            const nombreComercial = p.nombre_comercial || '';
                            return text === textoEscrito || razon === textoEscrito || nombreComercial === textoEscrito;
                        });
                        if (exacto) {
                            seleccionarCliente(exacto);
                        } else if (data.results.length === 1) {
                            // Si solo hay un resultado, seleccionarlo
                            seleccionarCliente(data.results[0]);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error buscando cliente:', error);
                });
        }
    });
}

function mostrarResultadosClientes(resultados) {
    clienteResultsDiv.innerHTML = '';
    if (resultados.length === 0) {
        clienteResultsDiv.innerHTML = '<div class="autocomplete-item">No se encontraron resultados</div>';
    } else {
        resultados.forEach(cliente => {
            const item = document.createElement('div');
            item.className = 'autocomplete-item';
            item.textContent = cliente.text;
            // Usar mousedown en lugar de click para evitar doble click
            item.addEventListener('mousedown', (e) => {
                e.preventDefault(); // Evitar que el input pierda el foco
                seleccionarCliente(cliente);
            });
            clienteResultsDiv.appendChild(item);
        });
    }
    clienteResultsDiv.classList.add('show');
}

function seleccionarCliente(cliente) {
    clienteSearchInput.value = cliente.text;
    clienteHiddenInput.value = cliente.id;
    clienteResultsDiv.classList.remove('show');
    
    // Actualizar datos del cliente en clientesData si no est치
    const existe = clientesData.find(p => p.id == cliente.id);
    if (!existe) {
        clientesData.push(cliente);
    }
    
    // Cargar opciones de plazo
    cargarOpcionesPlazo();
}

// Cerrar resultados al hacer click fuera
document.addEventListener('click', function(e) {
    if (!clienteSearchInput.contains(e.target) && !clienteResultsDiv.contains(e.target)) {
        clienteResultsDiv.classList.remove('show');
    }
});

// ========== AUTocompletado de Art칤culos ==========
function inicializarAutocompletadoArticulos() {
    const inputs = document.querySelectorAll('.articulo-search');
    if (inputs.length === 0) {
        console.log('No se encontraron inputs de art칤culo para inicializar');
        return;
    }
    
    inputs.forEach(input => {
        if (input.dataset.initialized) return;
        input.dataset.initialized = 'true';
        
        const row = input.closest('.linea-row');
        if (!row) {
            console.error('No se encontr칩 .linea-row para el input de art칤culo');
            return;
        }
        
        const articuloHiddenInput = row.querySelector('input[name*="-id_articulo"]');
        if (!articuloHiddenInput) {
            console.error('No se encontr칩 input hidden de art칤culo');
            return;
        }
        
        const container = input.closest('.autocomplete-container');
        if (!container) {
            console.error('No se encontr칩 .autocomplete-container para el input de art칤culo');
            return;
        }
        
        const resultsDiv = container.querySelector('.articulo-results');
        if (!resultsDiv) {
            console.error('No se encontr칩 .articulo-results en el contenedor');
            return;
        }
        
        const buscarBtn = container.querySelector('.buscar-articulo-btn');
        const toggleBtn = container.querySelector('.toggle-busqueda-btn');
        
        // Funci칩n para obtener el modo de b칰squeda actual
        function obtenerModoBusqueda() {
            return input.dataset.busquedaMode || 'nombre';
        }
        
        // Funci칩n para actualizar el placeholder seg칰n el modo
        function actualizarPlaceholder() {
            const modo = obtenerModoBusqueda();
            if (input.disabled) {
                input.placeholder = modo === 'codigo' ? 'Presione F2 o click en buscar (C칩digo)' : 'Presione F2 o click en buscar';
            } else {
                input.placeholder = modo === 'codigo' ? 'Escriba c칩digo cliente... (F2 para popup)' : 'Escriba para buscar... (F2 para popup)';
            }
        }
        
        // Funci칩n para alternar el modo de b칰squeda
        function alternarModoBusqueda() {
            const modoActual = obtenerModoBusqueda();
            const nuevoModo = modoActual === 'nombre' ? 'codigo' : 'nombre';
            
            input.dataset.busquedaMode = nuevoModo;
            if (toggleBtn) {
                toggleBtn.dataset.mode = nuevoModo;
                toggleBtn.textContent = nuevoModo === 'codigo' ? 'Codigo Cliente' : 'Nombre';
                toggleBtn.className = nuevoModo === 'codigo' ? 'btn btn-sm btn-warning toggle-busqueda-btn' : 'btn btn-sm btn-info toggle-busqueda-btn';
            }
            actualizarPlaceholder();
            
            // Limpiar resultados si hay algo escrito
            if (input.value) {
                input.value = '';
                resultsDiv.classList.remove('show');
            }
        }
        
        // Event listener para el bot칩n toggle
        if (toggleBtn) {
            toggleBtn.addEventListener('click', function(e) {
                e.preventDefault();
                alternarModoBusqueda();
            });
        }
        
        let articuloSearchTimeout;
        
        // Funci칩n para habilitar el campo y abrir b칰squeda
        function habilitarBusqueda() {
            input.disabled = false;
            input.readOnly = false;
            input.style.backgroundColor = '';
            input.focus();
            actualizarPlaceholder();
            // Abrir popup autom치ticamente
            abrirPopupArticulos(input, articuloHiddenInput, row);
        }
        
        // Event listener para el bot칩n de b칰squeda
        if (buscarBtn) {
            buscarBtn.addEventListener('click', function(e) {
                e.preventDefault();
                habilitarBusqueda();
            });
        }
        
        // Event listener para F2 - habilitar y abrir popup
        input.addEventListener('keydown', function(e) {
            if (e.key === 'F2') {
                e.preventDefault();
                habilitarBusqueda();
            }
            // Si el campo est치 deshabilitado, solo permitir F2
            if (input.disabled && e.key !== 'F2') {
                e.preventDefault();
                return false;
            }
        });
        
        // Cargar art칤culo actual si existe (en edici칩n)
        if (articuloHiddenInput && articuloHiddenInput.value) {
            const articuloId = articuloHiddenInput.value;
            fetch(`{% url 'ventas_ingreso:get_articulo_data' articulo_id=0 %}`.replace('0', articuloId))
                .then(response => response.json())
                .then(data => {
                    input.value = data.nombre || '';
                    // Si hay art칤culo, deshabilitar el campo (solo se puede cambiar con F2 o bot칩n)
                    input.disabled = true;
                    input.style.backgroundColor = '#e9ecef';
                    input.readOnly = true;
                    actualizarPlaceholder();
                    
                    // Convertir iva_valor a n칰mero antes de guardar
                    const ivaValorCarga = parseFloat(data.iva_valor) || 0;
                    
                    // Guardar datos en cache
                    articulosData[articuloId] = {
                        iva_valor: ivaValorCarga,
                        precio_venta: data.precio_venta || 0,
                        nombre: data.nombre || '',
                    };
                    
                    // Establecer el precio del maestro en el campo precio_original si no tiene valor
                    const precioOriginalInput = row.querySelector('.precio-original-input');
                    if (precioOriginalInput && (!precioOriginalInput.value || precioOriginalInput.value === '0' || precioOriginalInput.value === '0.00')) {
                        const precioVenta = data.precio_venta || 0;
                        precioOriginalInput.value = parseFloat(precioVenta).toFixed(2);
                        // Recalcular l칤nea despu칠s de establecer el precio
                        setTimeout(() => {
                            calcularLinea(row);
                        }, 100);
                    } else {
                        // Si ya hay precio, recalcular igualmente para asegurar que el IVA se calcule
                        setTimeout(() => {
                            calcularLinea(row);
                        }, 100);
                    }
                })
                .catch(() => {
                    // Si hay error, deshabilitar igualmente
                    input.disabled = true;
                });
        } else {
            // Si no hay art칤culo, deshabilitar el campo
            input.disabled = true;
            actualizarPlaceholder();
        }
        
        // Autocompletado solo funciona cuando el campo est치 habilitado
        input.addEventListener('input', function() {
            if (this.disabled) return;
            
            const query = this.value.trim();
            clearTimeout(articuloSearchTimeout);
            
            const minLength = obtenerModoBusqueda() === 'codigo' ? 1 : 2;
            if (query.length < minLength) {
                resultsDiv.classList.remove('show');
                return;
            }
            
            articuloSearchTimeout = setTimeout(() => {
                const modo = obtenerModoBusqueda();
                const clienteId = document.getElementById('id_cliente') ? document.getElementById('id_cliente').value : '';
                
                let url = `{% url 'ventas_ingreso:buscar_articulos' %}?q=${encodeURIComponent(query)}&modo=${modo}`;
                if (modo === 'codigo' && clienteId) {
                    url += `&cliente_id=${clienteId}`;
                }
                
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        mostrarResultadosArticulos(data.results, resultsDiv, articuloHiddenInput, input, row);
                    })
                    .catch(error => {
                        console.error('Error buscando art칤culos:', error);
                    });
            }, 300);
        });
        
        // Cerrar resultados al hacer click fuera
        document.addEventListener('click', function(e) {
            if (!input.contains(e.target) && !resultsDiv.contains(e.target) && !buscarBtn.contains(e.target) && (!toggleBtn || !toggleBtn.contains(e.target))) {
                resultsDiv.classList.remove('show');
            }
        });
    });
}

function mostrarResultadosArticulos(resultados, resultsDiv, hiddenInput, searchInput, row) {
    resultsDiv.innerHTML = '';
    if (resultados.length === 0) {
        resultsDiv.innerHTML = '<div class="autocomplete-item">No se encontraron resultados</div>';
    } else {
        resultados.forEach(articulo => {
            const item = document.createElement('div');
            item.className = 'autocomplete-item';
            item.textContent = articulo.text;
            // Usar mousedown en lugar de click para que funcione con un solo click
            item.addEventListener('mousedown', (e) => {
                e.preventDefault(); // Evitar que el input pierda el foco
                seleccionarArticulo(articulo, hiddenInput, searchInput, row);
            });
            resultsDiv.appendChild(item);
        });
    }
    resultsDiv.classList.add('show');
}

function seleccionarArticulo(articulo, hiddenInput, searchInput, row) {
    // Mostrar solo el nombre del art칤culo, no el c칩digo de proveedor
    searchInput.value = articulo.nombre || articulo.text || '';
    hiddenInput.value = articulo.id;
    const container = searchInput.closest('.autocomplete-container');
    const resultsDiv = container ? container.querySelector('.articulo-results') : searchInput.nextElementSibling;
    if (resultsDiv) resultsDiv.classList.remove('show');
    
    // Deshabilitar el campo despu칠s de seleccionar
    searchInput.disabled = true;
    searchInput.style.backgroundColor = '#e9ecef';
    searchInput.readOnly = true;
    
    // Actualizar placeholder seg칰n el modo
    const modo = searchInput.dataset.busquedaMode || 'nombre';
    searchInput.placeholder = modo === 'codigo' ? 'Presione F2 o click en buscar (C칩digo)' : 'Presione F2 o click en buscar';
    
    // Convertir iva_valor a n칰mero antes de guardar (puede venir como string)
    const ivaValor = parseFloat(articulo.iva_valor) || 0;
    
    // Guardar datos del art칤culo en cache (incluyendo precio_venta)
    articulosData[articulo.id] = {
        iva_valor: ivaValor,
        precio_venta: articulo.precio_venta || 0,
        nombre: articulo.nombre || '',
    };
    
    // Establecer precio_venta como precio_original (siempre IVA incluido en ventas)
    // IMPORTANTE: Establecer el precio del maestro sin importar la moneda
    const precioOriginalInput = row.querySelector('.precio-original-input');
    if (precioOriginalInput) {
        // Obtener el precio del art칤culo (precio_venta del maestro)
        let precioVenta = articulo.precio_venta || 0;
        // Si no viene en el objeto articulo, intentar obtenerlo del cache o de la lista
        if (!precioVenta && articulosData[articulo.id]) {
            precioVenta = articulosData[articulo.id].precio_venta || 0;
        }
        // Si a칰n no hay precio, buscar en la lista de art칤culos
        if (!precioVenta && articulosDataList) {
            const articuloEnLista = articulosDataList.find(a => a.id == articulo.id);
            if (articuloEnLista && articuloEnLista.precio_venta) {
                precioVenta = articuloEnLista.precio_venta;
            }
        }
        // Establecer el precio (aunque sea 0, para que el usuario vea que se carg칩)
        precioOriginalInput.value = parseFloat(precioVenta).toFixed(2);
        // Disparar evento input para que se recalcule autom치ticamente
        precioOriginalInput.dispatchEvent(new Event('input', { bubbles: true }));
    }
    
    // Asegurar que precio_iva_inc sea SI (siempre en ventas, no editable)
    const precioIvaIncSelect = document.getElementById('id_precio_iva_inc');
    if (precioIvaIncSelect) {
        precioIvaIncSelect.value = 'SI';
        precioIvaIncSelect.disabled = true;
        precioIvaIncSelect.style.backgroundColor = '#e9ecef';
        precioIvaIncSelect.style.cursor = 'not-allowed';
    }
    
    // Recalcular l칤nea
    calcularLinea(row);
}

// ========== POPUP MODAL PARA CLIENTES ==========
let currentClienteInput = null;
let currentClienteHiddenInput = null;

function abrirPopupClientes(input, hiddenInput) {
    console.log('abrirPopupClientes llamado');
    currentClienteInput = input;
    currentClienteHiddenInput = hiddenInput;
    const modal = document.getElementById('modal-clientes');
    const searchInput = document.getElementById('modal-cliente-search');
    const resultsDiv = document.getElementById('modal-cliente-results');
    
    if (!modal) {
        console.error('No se encontr칩 el modal de clientes');
        alert('Error: No se encontr칩 el modal de clientes.');
        return;
    }
    
    if (!searchInput) {
        console.error('No se encontr칩 el input de b칰squeda del modal');
        alert('Error: No se encontr칩 el campo de b칰squeda del modal.');
        return;
    }
    
    console.log('Abriendo modal de clientes');
    modal.style.display = 'block';
    searchInput.value = '';
    searchInput.focus();
    
    // Remover listeners anteriores para evitar duplicados
    const newSearchInput = searchInput.cloneNode(true);
    searchInput.parentNode.replaceChild(newSearchInput, searchInput);
    
    // Cargar todos los clientes inicialmente
    cargarClientesModal('');
    
    // B칰squeda en tiempo real
    let timeout;
    newSearchInput.addEventListener('input', function() {
        clearTimeout(timeout);
        const query = this.value.trim();
        timeout = setTimeout(() => {
            cargarClientesModal(query);
        }, 300);
    });
}

function cargarClientesModal(query) {
    const resultsDiv = document.getElementById('modal-cliente-results');
    const url = query ? `{% url 'ventas_ingreso:buscar_clientes' %}?q=${encodeURIComponent(query)}` : `{% url 'ventas_ingreso:buscar_clientes' %}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            mostrarClientesModal(data.results);
        })
        .catch(error => {
            console.error('Error:', error);
            resultsDiv.innerHTML = '<div class="modal-item">Error al cargar clientes</div>';
        });
}

function mostrarClientesModal(resultados) {
    const resultsDiv = document.getElementById('modal-cliente-results');
    resultsDiv.innerHTML = '';
    
    if (resultados.length === 0) {
        resultsDiv.innerHTML = '<div class="modal-item">No se encontraron resultados</div>';
        return;
    }
    
    resultados.forEach(cliente => {
        const item = document.createElement('div');
        item.className = 'modal-item';
        item.textContent = cliente.text;
        // Usar mousedown en lugar de click para que funcione con un solo click
        item.addEventListener('mousedown', (e) => {
            e.preventDefault(); // Evitar que el input pierda el foco
            seleccionarClienteModal(cliente);
        });
        resultsDiv.appendChild(item);
    });
}

function seleccionarClienteModal(cliente) {
    if (currentClienteInput && currentClienteHiddenInput) {
        currentClienteInput.value = cliente.text;
        currentClienteHiddenInput.value = cliente.id;
        
        // Actualizar datos del cliente
        const existe = clientesData.find(p => p.id == cliente.id);
        if (!existe) {
            clientesData.push(cliente);
        }
        
        // Cargar opciones de plazo
        cargarOpcionesPlazo();
        // Recalcular IVA en simplificada si aplica
        calcularImporteTotalSimplificada();
    }
    
    cerrarModalClientes();
}

function cerrarModalClientes() {
    document.getElementById('modal-clientes').style.display = 'none';
    currentClienteInput = null;
    currentClienteHiddenInput = null;
}

// ========== POPUP MODAL PARA ART칈CULOS ==========
let currentArticuloInput = null;
let currentArticuloHiddenInput = null;
let currentArticuloRow = null;

function abrirPopupArticulos(input, hiddenInput, row) {
    currentArticuloInput = input;
    currentArticuloHiddenInput = hiddenInput;
    currentArticuloRow = row;
    const modal = document.getElementById('modal-articulos');
    const searchInput = document.getElementById('modal-articulo-search');
    
    modal.style.display = 'block';
    searchInput.value = '';
    searchInput.focus();
    
    // Actualizar placeholder del modal seg칰n el modo
    const modo = input.dataset.busquedaMode || 'nombre';
    searchInput.placeholder = modo === 'codigo' ? 'Buscar por c칩digo de cliente...' : 'Buscar por nombre...';
    
    // Cargar todos los art칤culos inicialmente
    cargarArticulosModal('');
    
    // B칰squeda en tiempo real
    let timeout;
    // Remover listeners anteriores si existen
    const newInputHandler = function() {
        clearTimeout(timeout);
        const query = this.value.trim();
        timeout = setTimeout(() => {
            cargarArticulosModal(query);
        }, 300);
    };
    
    // Remover listener anterior y agregar uno nuevo
    searchInput.removeEventListener('input', searchInput._articuloModalHandler);
    searchInput._articuloModalHandler = newInputHandler;
    searchInput.addEventListener('input', newInputHandler);
}

function cargarArticulosModal(query) {
    const resultsDiv = document.getElementById('modal-articulo-results');
    
    // Obtener el modo del input actual
    const modo = currentArticuloInput ? (currentArticuloInput.dataset.busquedaMode || 'nombre') : 'nombre';
    const clienteId = document.getElementById('id_cliente') ? document.getElementById('id_cliente').value : '';
    
    let url = query ? `{% url 'ventas_ingreso:buscar_articulos' %}?q=${encodeURIComponent(query)}&modo=${modo}` : `{% url 'ventas_ingreso:buscar_articulos' %}?modo=${modo}`;
    if (modo === 'codigo' && clienteId) {
        url += `&cliente_id=${clienteId}`;
    }
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            mostrarArticulosModal(data.results);
        })
        .catch(error => {
            console.error('Error:', error);
            resultsDiv.innerHTML = '<div class="modal-item">Error al cargar art칤culos</div>';
        });
}

function mostrarArticulosModal(resultados) {
    const resultsDiv = document.getElementById('modal-articulo-results');
    resultsDiv.innerHTML = '';
    
    if (resultados.length === 0) {
        resultsDiv.innerHTML = '<div class="modal-item">No se encontraron resultados</div>';
        return;
    }
    
    resultados.forEach(articulo => {
        const item = document.createElement('div');
        item.className = 'modal-item';
        item.textContent = articulo.text;
        // Usar mousedown en lugar de click para que funcione con un solo click
        item.addEventListener('mousedown', (e) => {
            e.preventDefault(); // Evitar que el input pierda el foco
            seleccionarArticuloModal(articulo);
        });
        resultsDiv.appendChild(item);
    });
}

function seleccionarArticuloModal(articulo) {
    if (currentArticuloInput && currentArticuloHiddenInput && currentArticuloRow) {
        // Mostrar solo el nombre del art칤culo, no el c칩digo de proveedor
        currentArticuloInput.value = articulo.nombre || articulo.text || '';
        currentArticuloHiddenInput.value = articulo.id;
        
        // Deshabilitar el campo despu칠s de seleccionar
        currentArticuloInput.disabled = true;
        currentArticuloInput.style.backgroundColor = '#e9ecef';
        currentArticuloInput.readOnly = true;
        
        // Actualizar placeholder seg칰n el modo
        const modo = currentArticuloInput.dataset.busquedaMode || 'nombre';
        currentArticuloInput.placeholder = modo === 'codigo' ? 'Presione F2 o click en buscar (C칩digo)' : 'Presione F2 o click en buscar';
        
        // Convertir iva_valor a n칰mero antes de guardar (puede venir como string)
        const ivaValorModal = parseFloat(articulo.iva_valor) || 0;
        
        // Guardar datos del art칤culo en cache (incluyendo precio_venta)
        articulosData[articulo.id] = {
            iva_valor: ivaValorModal,
            precio_venta: articulo.precio_venta || 0,
            nombre: articulo.nombre || '',
        };
        
        // Establecer precio_venta como precio_original (siempre IVA incluido en ventas)
        // IMPORTANTE: Establecer el precio del maestro sin importar la moneda
        const precioOriginalInput = currentArticuloRow.querySelector('.precio-original-input');
        if (precioOriginalInput) {
            // Obtener el precio del art칤culo (precio_venta del maestro)
            let precioVenta = articulo.precio_venta || 0;
            // Si no viene en el objeto articulo, intentar obtenerlo del cache o de la lista
            if (!precioVenta && articulosData[articulo.id]) {
                precioVenta = articulosData[articulo.id].precio_venta || 0;
            }
            // Si a칰n no hay precio, buscar en la lista de art칤culos
            if (!precioVenta && articulosDataList) {
                const articuloEnLista = articulosDataList.find(a => a.id == articulo.id);
                if (articuloEnLista && articuloEnLista.precio_venta) {
                    precioVenta = articuloEnLista.precio_venta;
                }
            }
            // Establecer el precio (aunque sea 0, para que el usuario vea que se carg칩)
            precioOriginalInput.value = parseFloat(precioVenta).toFixed(2);
            // Disparar evento input para que se recalcule autom치ticamente
            precioOriginalInput.dispatchEvent(new Event('input', { bubbles: true }));
        }
        
        // Asegurar que precio_iva_inc sea SI (siempre en ventas, no editable)
        const precioIvaIncSelect = document.getElementById('id_precio_iva_inc');
        if (precioIvaIncSelect) {
            precioIvaIncSelect.value = 'SI';
            precioIvaIncSelect.disabled = true;
            precioIvaIncSelect.style.backgroundColor = '#e9ecef';
            precioIvaIncSelect.style.cursor = 'not-allowed';
        }
        
        // Recalcular l칤nea
        calcularLinea(currentArticuloRow);
    }
    
    cerrarModalArticulos();
}

function cerrarModalArticulos() {
    document.getElementById('modal-articulos').style.display = 'none';
    currentArticuloInput = null;
    currentArticuloHiddenInput = null;
    currentArticuloRow = null;
}

// Cerrar modales al hacer click en X o fuera
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.close-modal').forEach(closeBtn => {
        closeBtn.addEventListener('click', function() {
            const modal = this.closest('.modal');
            if (modal.id === 'modal-clientes') {
                cerrarModalClientes();
            } else if (modal.id === 'modal-articulos') {
                cerrarModalArticulos();
            }
        });
    });
    
    window.addEventListener('click', function(e) {
        const modalClientes = document.getElementById('modal-clientes');
        const modalArticulos = document.getElementById('modal-articulos');
        if (e.target === modalClientes) {
            cerrarModalClientes();
        }
        if (e.target === modalArticulos) {
            cerrarModalArticulos();
        }
    });
});
const formasPagoData = JSON.parse('{{ formas_pago_data|escapejs }}');
const articulosDataList = JSON.parse('{{ articulos_data|escapejs }}');
const articulosData = {}; // Cache para datos de art칤culos

// Funci칩n para obtener datos de art칤culo
function getArticuloData(articuloId) {
    if (articulosData[articuloId]) {
        // Asegurar que iva_valor sea n칰mero
        const data = articulosData[articuloId];
        if (typeof data.iva_valor !== 'number') {
            data.iva_valor = parseFloat(data.iva_valor) || 0;
        }
        return Promise.resolve(data);
    }
    // Si no est치 en cache, buscar en la lista
    const articulo = articulosDataList.find(a => a.id == articuloId);
    if (articulo) {
        // Convertir iva_valor a n칰mero
        const ivaValor = parseFloat(articulo.iva_valor) || 0;
        articulosData[articuloId] = {
            iva_valor: ivaValor,
            precio_venta: articulo.precio_venta || 0,
            nombre: articulo.nombre || '',
        };
        return Promise.resolve(articulosData[articuloId]);
    }
    // Si no est치, intentar v칤a AJAX
    return fetch(`{% url 'ventas_ingreso:get_articulo_data' articulo_id=0 %}`.replace('0', articuloId))
        .then(response => response.json())
        .then(data => {
            // Convertir iva_valor a n칰mero
            const ivaValor = parseFloat(data.iva_valor) || 0;
            articulosData[articuloId] = {
                iva_valor: ivaValor,
                precio_venta: data.precio_venta || 0,
                nombre: data.nombre || '',
            };
            return articulosData[articuloId];
        })
        .catch(error => {
            console.error('Error al obtener datos del art칤culo:', error);
            return { iva_valor: 0, precio_venta: 0 };
        });
}

// Funci칩n para calcular l칤nea
function calcularLinea(row) {
    const cantidad = parseFloat(row.querySelector('.cantidad-input').value) || 0;
    const precioOriginal = parseFloat(row.querySelector('.precio-original-input').value) || 0;
    const descuento = parseFloat(row.querySelector('.descuento-input').value) || 0;
    
    // Buscar el input hidden del art칤culo (en ventas no hay select, solo input hidden)
    const articuloHiddenInput = row.querySelector('input[name*="-id_articulo"]');
    let articuloId = articuloHiddenInput ? articuloHiddenInput.value : null;
    
    const precioIvaInc = document.getElementById('id_precio_iva_inc') ? document.getElementById('id_precio_iva_inc').value : 'SI';
    
    // Calcular precio neto unitario
    const descuentoDecimal = descuento / 100;
    const precioNetoUnitario = precioOriginal * (1 - descuentoDecimal);
    
    // Obtener IVA del art칤culo
    let ivaValor = 0;
    if (articuloId) {
        getArticuloData(articuloId).then(data => {
            // Convertir iva_valor a n칰mero (puede venir como string o n칰mero)
            ivaValor = parseFloat(data.iva_valor) || 0;
            calcularLineaConIVA(row, cantidad, precioNetoUnitario, ivaValor, precioIvaInc);
        });
    } else {
        calcularLineaConIVA(row, cantidad, precioNetoUnitario, 0, precioIvaInc);
    }
}

function calcularLineaConIVA(row, cantidad, precioNetoUnitario, ivaValor, precioIvaInc) {
    // Asegurar que ivaValor sea n칰mero
    ivaValor = parseFloat(ivaValor) || 0;
    
    // Verificar tipo de documento
    const tipoDocumentoSelect = document.getElementById('id_tipo_documento');
    const tipoDocumentoCodigo = tipoDocumentoSelect ? tipoDocumentoSelect.options[tipoDocumentoSelect.selectedIndex]?.value : '';
    const esMovcli = tipoDocumentoCodigo === 'movcli';
    const esFactexpo = tipoDocumentoCodigo === 'factexpo';
    const esEfactura = tipoDocumentoCodigo === 'efactura';
    
    // Determinar IVA seg칰n tipo de documento:
    // - efactura: discrimina el IVA del art칤culo
    // - factexpo: IVA = 0 (exportaciones sin IVA)
    // - movcli: IVA = 0 (venta en negro)
    if (esFactexpo || esMovcli) {
        ivaValor = 0;
    } else if (esEfactura) {
        // Para efactura, usar el IVA del art칤culo (ya viene en ivaValor)
        // No hacer nada, mantener el ivaValor del art칤culo
    }
    
    // En ventas, los precios SIEMPRE son con IVA incluido
    // F칩rmulas correctas:
    // SUBTOTAL: (PRECIO_ORIGINAL * (1 - DESCUENTO)) / (1 + IVA%) * CANTIDAD
    // IVA: SUBTOTAL * IVA%
    // TOTAL: SUBTOTAL + IVA
    let subTotalUnitario, ivaUnitario;
    
    // precioIvaInc siempre deber칤a ser 'SI' en ventas, pero por si acaso
    if (precioIvaInc === 'SI') {
        // IVA incluido: discriminar el IVA
        if (ivaValor > 0) {
            // SUBTOTAL unitario = precio_neto / (1 + IVA%)
            subTotalUnitario = precioNetoUnitario / (1 + ivaValor);
            // IVA unitario = SUBTOTAL * IVA% (f칩rmula correcta)
            ivaUnitario = subTotalUnitario * ivaValor;
        } else {
            // Sin IVA (factexpo, movcli o art칤culo sin IVA)
            subTotalUnitario = precioNetoUnitario;
            ivaUnitario = 0;
        }
    } else {
        // IVA no incluido (no deber칤a pasar en ventas, pero por compatibilidad)
        subTotalUnitario = precioNetoUnitario;
        ivaUnitario = subTotalUnitario * ivaValor;
    }
    
    // Multiplicar por cantidad para sub_total e iva
    // SUBTOTAL = subTotalUnitario * CANTIDAD
    const subTotal = subTotalUnitario * cantidad;
    // IVA = ivaUnitario * CANTIDAD (o tambi칠n: subTotal * ivaValor)
    const iva = ivaUnitario * cantidad;
    // precio_neto NO se multiplica por cantidad (solo precio menos descuento)
    const precioNeto = precioNetoUnitario;
    const total = subTotal + iva;
    
    // Actualizar displays
    row.querySelector('.precio-neto-display').textContent = precioNeto.toFixed(2);
    row.querySelector('.sub-total-display').textContent = subTotal.toFixed(2);
    row.querySelector('.iva-display').textContent = iva.toFixed(2);
    row.querySelector('.total-display').textContent = total.toFixed(2);
    
    // Recalcular totales
    calcularTotales();
}

// Funci칩n para calcular totales
function calcularTotales() {
    let totalSubTotal = 0;
    let totalIva = 0;
    let totalTotal = 0;
    
    document.querySelectorAll('.linea-row').forEach(row => {
        // Ignorar filas ocultas o marcadas para eliminar
        if (row.style.display !== 'none') {
            const deleteCheckbox = row.querySelector('.delete-checkbox');
            const deleteField = row.querySelector('input[name*="-DELETE"]');
            const isDeleted = (deleteCheckbox && deleteCheckbox.value === '1') || 
                            (deleteField && deleteField.checked);
            if (!isDeleted) {
                totalSubTotal += parseFloat(row.querySelector('.sub-total-display').textContent) || 0;
                totalIva += parseFloat(row.querySelector('.iva-display').textContent) || 0;
                totalTotal += parseFloat(row.querySelector('.total-display').textContent) || 0;
            }
        }
    });
    
    document.getElementById('total-subtotal').textContent = totalSubTotal.toFixed(2);
    document.getElementById('total-iva').textContent = totalIva.toFixed(2);
    document.getElementById('total-total').textContent = totalTotal.toFixed(2);
}

// Manejo de tipo de venta (CONVENCIONAL/SIMPLIFICADA)
function actualizarVistaSegunTipoVenta() {
    const tipoVentaSelect = document.getElementById('id_tipo_venta');
    if (!tipoVentaSelect) return;
    
    const tipoVenta = tipoVentaSelect.value;
    const lineasSection = document.getElementById('lineas-section');
    const totalesManualesRow = document.getElementById('totales-manuales-row');
    const observacionesSimplificadaRow = document.getElementById('observaciones-simplificada-row');
    const precioIvaIncRow = document.getElementById('precio-iva-inc-row');
    const subTotalInput = document.getElementById('id_sub_total');
    const ivaInput = document.getElementById('id_iva');
    const importeTotalInput = document.getElementById('id_importe_total');
    
    if (tipoVenta === 'SIMPLIFICADA') {
        // Ocultar secci칩n de l칤neas
        if (lineasSection) lineasSection.style.display = 'none';
        // Mostrar totales manuales
        if (totalesManualesRow) totalesManualesRow.style.display = 'flex';
        // Mostrar observaciones simplificada
        if (observacionesSimplificadaRow) observacionesSimplificadaRow.style.display = 'flex';
        // Ocultar precio IVA inc (no aplica en simplificada)
        if (precioIvaIncRow) precioIvaIncRow.style.display = 'none';
        // Hacer campos de totales requeridos y editables
        if (subTotalInput) {
            subTotalInput.required = true;
            subTotalInput.readOnly = false;
        }
        if (ivaInput) {
            ivaInput.required = true;
            ivaInput.readOnly = false;
        }
        if (importeTotalInput) {
            importeTotalInput.required = true;
            importeTotalInput.readOnly = true; // Solo lectura, se calcula autom치ticamente
        }
        // Calcular importe total al cambiar a simplificada
        calcularImporteTotalSimplificada();
    } else {
        // Mostrar secci칩n de l칤neas
        if (lineasSection) lineasSection.style.display = 'block';
        // Ocultar totales manuales
        if (totalesManualesRow) totalesManualesRow.style.display = 'none';
        // Ocultar observaciones simplificada
        if (observacionesSimplificadaRow) observacionesSimplificadaRow.style.display = 'none';
        // Mostrar precio IVA inc
        if (precioIvaIncRow) precioIvaIncRow.style.display = 'flex';
        // Hacer campos de totales readonly (se calculan autom치ticamente)
        if (subTotalInput) {
            subTotalInput.required = false;
            subTotalInput.readOnly = true;
        }
        if (ivaInput) {
            ivaInput.required = false;
            ivaInput.readOnly = true;
        }
        if (importeTotalInput) {
            importeTotalInput.required = false;
            importeTotalInput.readOnly = true;
        }
    }
}

// Funci칩n para calcular importe total en venta simplificada
function calcularImporteTotalSimplificada() {
    const tipoVentaSelect = document.getElementById('id_tipo_venta');
    if (!tipoVentaSelect || tipoVentaSelect.value !== 'SIMPLIFICADA') return;
    
    const subTotalInput = document.getElementById('id_sub_total');
    const ivaInput = document.getElementById('id_iva');
    const importeTotalInput = document.getElementById('id_importe_total');
    const tipoDocumentoSelect = document.getElementById('id_tipo_documento');
    
    if (!subTotalInput || !ivaInput || !importeTotalInput) return;
    
    const subTotal = parseFloat(subTotalInput.value) || 0;
    let iva = parseFloat(ivaInput.value) || 0;
    
    // Verificar si debe ser IVA = 0 (movcli - venta en negro)
    let es_movcli = false;
    
    if (tipoDocumentoSelect) {
        const tipoDocOption = tipoDocumentoSelect.options[tipoDocumentoSelect.selectedIndex];
        if (tipoDocOption) {
            const tipoDocValue = tipoDocOption.value;
            const tipoDocText = tipoDocOption.text;
            es_movcli = tipoDocValue === 'movcli' || tipoDocText.includes('movcli') || tipoDocText.includes('Movimiento Cliente');
        }
    }
    
    // Si es movcli, forzar IVA = 0
    const ivaHelpText = document.getElementById('iva-help-text');
    if (es_movcli) {
        iva = 0;
        ivaInput.value = '0.00';
        ivaInput.readOnly = true;
        ivaInput.style.backgroundColor = '#f0f0f0';
        ivaInput.style.cursor = 'not-allowed';
        ivaInput.title = 'IVA = 0 para Movimiento Cliente';
        if (ivaHelpText) ivaHelpText.textContent = 'IVA = 0 (Movimiento Cliente)';
        ivaInput.setCustomValidity('');
        ivaInput.style.borderColor = '';
    } else {
        ivaInput.readOnly = false;
        ivaInput.style.backgroundColor = '';
        ivaInput.style.cursor = '';
        ivaInput.title = '';
        if (ivaHelpText) ivaHelpText.textContent = 'M치ximo: 22% del Sub Total';
        
        // Validar que IVA no supere el 22% del Sub Total
        if (subTotal > 0) {
            const ivaMaximo = subTotal * 0.22;
            if (iva > ivaMaximo) {
                ivaInput.setCustomValidity(`El IVA no puede ser mayor al 22% del Sub Total. M치ximo: ${ivaMaximo.toFixed(2)}`);
                ivaInput.style.borderColor = '#dc3545';
                ivaInput.style.backgroundColor = '#fff5f5';
            } else {
                ivaInput.setCustomValidity('');
                ivaInput.style.borderColor = '';
                ivaInput.style.backgroundColor = '';
            }
        } else {
            ivaInput.setCustomValidity('');
            ivaInput.style.borderColor = '';
            ivaInput.style.backgroundColor = '';
        }
    }
    
    // Calcular importe total
    const importeTotal = subTotal + iva;
    importeTotalInput.value = importeTotal.toFixed(2);
}

// Event listener para tipo de venta
const tipoVentaSelect = document.getElementById('id_tipo_venta');
if (tipoVentaSelect) {
    tipoVentaSelect.addEventListener('change', actualizarVistaSegunTipoVenta);
    // Ejecutar al cargar la p치gina
    actualizarVistaSegunTipoVenta();
}

// Event listeners para calcular importe total en simplificada
document.addEventListener('DOMContentLoaded', function() {
    const subTotalInput = document.getElementById('id_sub_total');
    const ivaInput = document.getElementById('id_iva');
    const tipoDocumentoSelect = document.getElementById('id_tipo_documento');
    const clienteHiddenInput = document.getElementById('id_cliente');
    
    if (subTotalInput) {
        subTotalInput.addEventListener('input', calcularImporteTotalSimplificada);
        subTotalInput.addEventListener('change', calcularImporteTotalSimplificada);
    }
    
    if (ivaInput) {
        ivaInput.addEventListener('input', calcularImporteTotalSimplificada);
        ivaInput.addEventListener('change', calcularImporteTotalSimplificada);
    }
    
    // Event listener para tipo de documento (para detectar movcli)
    if (tipoDocumentoSelect) {
        tipoDocumentoSelect.addEventListener('change', function() {
            calcularImporteTotalSimplificada();
        });
    }
});

// Manejo de forma de pago
const formaPagoSelect = document.getElementById('id_forma_pago');
if (formaPagoSelect) {
    formaPagoSelect.addEventListener('change', function() {
        const formaPago = this.value;
        console.log('=== Cambio de forma de pago ===', formaPago);
        const disponibilidadGroup = document.getElementById('disponibilidad-group');
        const plazoGroup = document.getElementById('plazo-group');
        const fechaVencimientoGroup = document.getElementById('fecha-vencimiento-group');
        
        if (!disponibilidadGroup || !plazoGroup || !fechaVencimientoGroup) {
            console.error('ERROR: No se encontraron los grupos de disponibilidad/plazo/fecha vencimiento');
            return;
        }
        
        if (formaPago === 'CONTADO') {
            disponibilidadGroup.style.display = 'block';
            plazoGroup.style.display = 'none';
            fechaVencimientoGroup.style.display = 'none';
            const disponibilidadInput = document.getElementById('id_disponibilidad');
            const plazoInput = document.getElementById('id_plazo');
            if (disponibilidadInput) disponibilidadInput.required = true;
            if (plazoInput) plazoInput.required = false;
            console.log('Forma de pago: CONTADO - Mostrando disponibilidad');
        } else if (formaPago === 'CREDITO') {
            disponibilidadGroup.style.display = 'none';
            plazoGroup.style.display = 'block';
            fechaVencimientoGroup.style.display = 'block';
            const disponibilidadInput = document.getElementById('id_disponibilidad');
            const plazoInput = document.getElementById('id_plazo');
            if (disponibilidadInput) disponibilidadInput.required = false;
            if (plazoInput) plazoInput.required = true;
            console.log('Forma de pago: CREDITO - Mostrando plazo y fecha vencimiento');
            
            // Cargar opciones de plazo del cliente
            cargarOpcionesPlazo();
            
            // Configurar el select de plazo si no est치 configurado
            setTimeout(() => {
                const plazoSelect = document.getElementById('id_plazo');
                if (plazoSelect) {
                    // Si el select no tiene event listener, configurarlo
                    if (!plazoSelect.hasAttribute('data-listener-configured')) {
                        configurarPlazoSelect();
                    }
                    
                    // Si hay un plazo seleccionado y no es "elegir" ni "VENCIMIENTO_PACTADO", calcular fecha
                    if (plazoSelect.value && plazoSelect.value !== 'VENCIMIENTO_PACTADO' && plazoSelect.value !== 'elegir') {
                        const fechaDocumentoInput = document.getElementById('id_fecha_documento');
                        if (fechaDocumentoInput && fechaDocumentoInput.value) {
                            calcularFechaVencimiento(plazoSelect.value, fechaDocumentoInput.value);
                        }
                    } else if (plazoSelect.value === 'elegir') {
                        // Si es "elegir", habilitar el campo de fecha
                        const fechaVencimientoInput = document.getElementById('id_fecha_vencimiento');
                        if (fechaVencimientoInput) {
                            fechaVencimientoInput.disabled = false;
                            fechaVencimientoInput.required = true;
                            fechaVencimientoInput.style.backgroundColor = '';
                        }
                    } else if (plazoSelect.value === 'VENCIMIENTO_PACTADO') {
                        // Si es "VENCIMIENTO_PACTADO", deshabilitar y limpiar fecha
                        const fechaVencimientoInput = document.getElementById('id_fecha_vencimiento');
                        if (fechaVencimientoInput) {
                            fechaVencimientoInput.disabled = true;
                            fechaVencimientoInput.value = '';
                            fechaVencimientoInput.required = false;
                            fechaVencimientoInput.style.backgroundColor = '#e9ecef';
                        }
                    }
                }
            }, 300);
        } else {
            // Si no es CONTADO ni CREDITO, ocultar ambos
            disponibilidadGroup.style.display = 'none';
            plazoGroup.style.display = 'none';
            fechaVencimientoGroup.style.display = 'none';
        }
    });
    
    // Inicializar seg칰n el valor actual
    if (formaPagoSelect.value) {
        formaPagoSelect.dispatchEvent(new Event('change'));
    }
} else {
    console.error('ERROR: No se encontr칩 el select de forma_pago');
}

// Cargar opciones de plazo seg칰n cliente
function cargarOpcionesPlazo() {
    console.log('=== cargarOpcionesPlazo() llamado ===');
    // Usar la variable global clienteHiddenInput
    const plazoSelect = document.getElementById('id_plazo');
    
    if (!clienteHiddenInput) {
        console.error('ERROR: No se encontr칩 el input hidden de cliente');
        // Intentar buscarlo de nuevo
        clienteHiddenInput = document.getElementById('id_cliente') || 
                               document.querySelector('input[name="id_cliente"]') ||
                               document.querySelector('.autocomplete-container input[type="hidden"]');
        if (clienteHiddenInput) {
            if (clienteHiddenInput.id !== 'id_cliente') {
                clienteHiddenInput.id = 'id_cliente';
            }
            console.log('Input hidden encontrado despu칠s de b칰squeda adicional');
        } else {
            return;
        }
    }
    
    if (!plazoSelect) {
        console.error('ERROR: No se encontr칩 el select de plazo');
        return;
    }
    
    const clienteId = clienteHiddenInput.value;
    console.log('Cliente ID:', clienteId);
    console.log('Plazo Select encontrado:', plazoSelect);
    console.log('ClientesData:', clientesData);
    console.log('FormasPagoData:', formasPagoData);
    
    if (!clienteId) {
        console.warn('No hay cliente seleccionado');
        plazoSelect.innerHTML = '<option value="">---------</option>';
        return;
    }
    
    // Buscar el cliente en los datos (comparar como string y n칰mero)
    let cliente = clientesData.find(p => {
        const pId = String(p.id);
        const cliId = String(clienteId);
        return pId === cliId || p.id == clienteId || p.id == parseInt(clienteId);
    });
    
    console.log('Cliente encontrado en datos locales:', cliente);
    
    // Si no se encuentra en los datos locales, buscar en el servidor
    if (!cliente) {
        console.log('Cliente no encontrado en datos locales, buscando en servidor...', clienteId);
        fetch(`{% url 'ventas_ingreso:buscar_clientes' %}?q=`)
            .then(response => response.json())
            .then(data => {
                console.log('Datos del servidor:', data);
                cliente = data.results.find(p => {
                    const pId = String(p.id);
                    const cliId = String(clienteId);
                    return pId === cliId || p.id == clienteId || p.id == parseInt(clienteId);
                });
                if (cliente) {
                    console.log('Cliente encontrado en servidor:', cliente);
                    // Agregar a los datos locales
                    clientesData.push(cliente);
                    actualizarOpcionesPlazo(cliente, plazoSelect);
                } else {
                    console.warn('No se encontr칩 el cliente en el servidor:', clienteId);
                    plazoSelect.innerHTML = `
                        <option value="elegir">Elegir</option>
                        <option value="VENCIMIENTO_PACTADO">Vencimiento Pactado</option>
                    `;
                }
            })
            .catch(error => {
                console.error('Error buscando cliente:', error);
                plazoSelect.innerHTML = `
                    <option value="elegir">Elegir</option>
                    <option value="VENCIMIENTO_PACTADO">Vencimiento Pactado</option>
                `;
            });
        return;
    }
    
    actualizarOpcionesPlazo(cliente, plazoSelect);
}

function actualizarOpcionesPlazo(cliente, plazoSelect) {
    console.log('=== actualizarOpcionesPlazo() ===');
    console.log('Cliente completo:', JSON.stringify(cliente, null, 2));
    console.log('formadepago del cliente:', cliente.formadepago);
    console.log('formasPagoData disponible:', formasPagoData ? 'S칤' : 'No');
    
    // Si el cliente tiene forma de pago definida
    if (cliente.formadepago && cliente.formadepago !== '' && cliente.formadepago !== 'NO_ASIGNADA' && cliente.formadepago !== null) {
        console.log('Buscando forma de pago con c칩digo:', cliente.formadepago);
        const formaPago = formasPagoData.find(fp => {
            console.log('Comparando:', fp.codigo, 'con', cliente.formadepago);
            return fp.codigo === cliente.formadepago || String(fp.codigo) === String(cliente.formadepago);
        });
        console.log('Forma de pago encontrada:', formaPago);
        
        if (formaPago) {
            plazoSelect.innerHTML = `
                <option value="${cliente.formadepago}">${formaPago.descripcion}</option>
                <option value="elegir">Elegir</option>
                <option value="VENCIMIENTO_PACTADO">Vencimiento Pactado</option>
            `;
            // Seleccionar autom치ticamente el plazo del cliente
            plazoSelect.value = cliente.formadepago;
            console.log('Plazo seleccionado:', plazoSelect.value);
            
            // Calcular fecha de vencimiento autom치ticamente
            setTimeout(() => {
                const fechaDocumentoInput = document.getElementById('id_fecha_documento');
                if (fechaDocumentoInput && fechaDocumentoInput.value) {
                    // Si hay fecha de documento, calcular directamente
                    console.log('Calculando fecha de vencimiento al cargar plazo del cliente');
                    calcularFechaVencimiento(cliente.formadepago, fechaDocumentoInput.value);
                } else {
                    // Si no hay fecha, disparar el evento change para que se calcule cuando haya fecha
                    plazoSelect.dispatchEvent(new Event('change'));
                }
            }, 200);
        } else {
            console.warn('Forma de pago no encontrada en formasPagoData. C칩digo buscado:', cliente.formadepago);
            console.warn('Formas de pago disponibles:', formasPagoData.map(fp => fp.codigo));
            plazoSelect.innerHTML = `
                <option value="elegir">Elegir</option>
                <option value="VENCIMIENTO_PACTADO">Vencimiento Pactado</option>
            `;
        }
    } else {
        console.log('Cliente sin forma de pago definida. formadepago:', cliente.formadepago);
        // Si no tiene forma de pago, solo mostrar opciones gen칠ricas
        plazoSelect.innerHTML = `
            <option value="elegir">Elegir</option>
            <option value="VENCIMIENTO_PACTADO">Vencimiento Pactado</option>
        `;
    }
}

// Manejo de plazo - debe estar dentro de DOMContentLoaded o ejecutarse despu칠s
function configurarPlazoSelect() {
    const plazoSelectElement = document.getElementById('id_plazo');
    if (!plazoSelectElement) {
        console.warn('No se encontr칩 el select de plazo, reintentando...');
        setTimeout(configurarPlazoSelect, 100);
        return;
    }
    
    // Marcar como configurado para evitar m칰ltiples listeners
    if (plazoSelectElement.hasAttribute('data-listener-configured')) {
        return;
    }
    plazoSelectElement.setAttribute('data-listener-configured', 'true');
    
    plazoSelectElement.addEventListener('change', function() {
        const plazo = this.value;
        const fechaVencimientoInput = document.getElementById('id_fecha_vencimiento');
        const fechaDocumentoInput = document.getElementById('id_fecha_documento');
        
        if (!fechaVencimientoInput || !fechaDocumentoInput) {
            console.warn('No se encontraron los campos de fecha');
            return;
        }
        
        console.log('=== Cambio de plazo ===', plazo);
        
        if (plazo === 'VENCIMIENTO_PACTADO') {
            // Vencimiento Pactado: deshabilitar campo y limpiar fecha
            fechaVencimientoInput.disabled = true;
            fechaVencimientoInput.value = '';
            fechaVencimientoInput.required = false;
            fechaVencimientoInput.style.backgroundColor = '#e9ecef';
            console.log('VENCIMIENTO_PACTADO: Campo deshabilitado y fecha limpiada');
        } else if (plazo === 'elegir') {
            // Elegir: habilitar campo para que el usuario ingrese manualmente
            fechaVencimientoInput.disabled = false;
            fechaVencimientoInput.required = true;
            fechaVencimientoInput.style.backgroundColor = '';
            fechaVencimientoInput.focus();
            console.log('Elegir: Campo habilitado para ingreso manual');
        } else if (plazo && plazo !== 'elegir' && plazo !== 'VENCIMIENTO_PACTADO') {
            // Plazo espec칤fico: calcular fecha autom치ticamente
            fechaVencimientoInput.disabled = false;
            fechaVencimientoInput.required = true;
            fechaVencimientoInput.style.backgroundColor = '';
            
            if (fechaDocumentoInput.value) {
                console.log('Calculando fecha de vencimiento por cambio de plazo:', plazo);
                calcularFechaVencimiento(plazo, fechaDocumentoInput.value);
            } else {
                // Si no hay fecha de documento, esperar a que se ingrese
                console.log('Esperando fecha de documento para calcular vencimiento');
                // Agregar listener temporal para cuando se ingrese la fecha
                const tempListener = function() {
                    if (fechaDocumentoInput.value) {
                        calcularFechaVencimiento(plazo, fechaDocumentoInput.value);
                        fechaDocumentoInput.removeEventListener('change', tempListener);
                    }
                };
                fechaDocumentoInput.addEventListener('change', tempListener);
            }
        }
    });
    
    // Si ya hay un valor seleccionado, disparar el evento para inicializar
    if (plazoSelectElement.value) {
        setTimeout(() => {
            plazoSelectElement.dispatchEvent(new Event('change'));
        }, 100);
    }
}

// Configurar el select de plazo cuando el DOM est칠 listo
// Se llama desde DOMContentLoaded m치s abajo para asegurar que est칠 despu칠s de cargar opciones

// Calcular fecha_vencimiento cuando cambia fecha_documento
const fechaDocumentoInput = document.getElementById('id_fecha_documento');
if (fechaDocumentoInput) {
    fechaDocumentoInput.addEventListener('change', function() {
        const plazoSelect = document.getElementById('id_plazo');
        if (plazoSelect) {
            const plazo = plazoSelect.value;
            if (plazo && plazo !== 'VENCIMIENTO_PACTADO' && plazo !== 'elegir' && this.value) {
                console.log('Calculando fecha de vencimiento por cambio de fecha documento');
                calcularFechaVencimiento(plazo, this.value);
            }
        }
    });
    
    // Tambi칠n calcular cuando se carga la p치gina si ya hay valores
    if (fechaDocumentoInput.value) {
        const plazoSelect = document.getElementById('id_plazo');
        if (plazoSelect && plazoSelect.value && plazoSelect.value !== 'VENCIMIENTO_PACTADO' && plazoSelect.value !== 'elegir') {
            setTimeout(() => {
                calcularFechaVencimiento(plazoSelect.value, fechaDocumentoInput.value);
            }, 500);
        }
    }
}

// Calcular fecha de vencimiento
function calcularFechaVencimiento(plazoCodigo, fechaDocumento) {
    console.log('=== calcularFechaVencimiento ===');
    console.log('Plazo c칩digo:', plazoCodigo);
    console.log('Fecha documento:', fechaDocumento);
    
    const formaPago = formasPagoData.find(fp => fp.codigo === plazoCodigo);
    if (!formaPago) {
        console.warn('Forma de pago no encontrada:', plazoCodigo);
        return;
    }
    
    console.log('Forma de pago encontrada:', formaPago);
    console.log('fin_de_mes:', formaPago.fin_de_mes);
    console.log('plazo_en_dias:', formaPago.plazo_en_dias);
    
    // Parsear la fecha del documento
    const fecha = new Date(fechaDocumento);
    if (isNaN(fecha.getTime())) {
        console.error('Fecha inv치lida:', fechaDocumento);
        return;
    }
    
    let fechaBase;
    
    // Determinar la fecha base seg칰n fin_de_mes
    // fin_de_mes puede ser true/false o 1/0
    const esFinDeMes = formaPago.fin_de_mes === true || formaPago.fin_de_mes === 1 || formaPago.fin_de_mes === '1';
    
    if (esFinDeMes) {
        // Fin de mes: usar el 칰ltimo d칤a del mes de la factura
        // Ejemplo: si la factura es del 20 de noviembre, usar el 30 de noviembre
        const ultimoDia = new Date(fecha.getFullYear(), fecha.getMonth() + 1, 0);
        fechaBase = ultimoDia;
        console.log('Usando fin de mes. 칔ltimo d칤a del mes:', ultimoDia.toISOString().split('T')[0]);
    } else {
        // No es fin de mes: usar la fecha del documento directamente
        // Ejemplo: si la factura es del 19 de noviembre, usar el 19 de noviembre
        fechaBase = new Date(fecha);
        console.log('No es fin de mes. Usando fecha del documento:', fechaBase.toISOString().split('T')[0]);
    }
    
    // Sumar los d칤as de plazo
    const fechaVencimiento = new Date(fechaBase);
    fechaVencimiento.setDate(fechaVencimiento.getDate() + formaPago.plazo_en_dias);
    
    const fechaVencimientoFormateada = fechaVencimiento.toISOString().split('T')[0];
    console.log('Fecha de vencimiento calculada:', fechaVencimientoFormateada);
    
    const fechaVencimientoInput = document.getElementById('id_fecha_vencimiento');
    if (fechaVencimientoInput) {
        fechaVencimientoInput.value = fechaVencimientoFormateada;
        console.log('Fecha de vencimiento actualizada en el input');
    } else {
        console.error('No se encontr칩 el input de fecha de vencimiento');
    }
}

// Event listeners para l칤neas
// Inicializar cuando el DOM est칠 listo
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', inicializarTodo);
} else {
    inicializarTodo();
}

// Funci칩n para convertir fechas de dd/MM/yyyy a yyyy-MM-dd
function convertirFechas() {
    const fechaDocumentoInput = document.getElementById('id_fecha_documento');
    const fechaVencimientoInput = document.getElementById('id_fecha_vencimiento');
    
    function convertirFecha(input) {
        if (!input || !input.value) return;
        
        // Si ya est치 en formato yyyy-MM-dd, no hacer nada
        if (/^\d{4}-\d{2}-\d{2}$/.test(input.value)) return;
        
        // Intentar convertir de dd/MM/yyyy a yyyy-MM-dd
        const fechaMatch = input.value.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
        if (fechaMatch) {
            const [, dia, mes, anio] = fechaMatch;
            input.value = `${anio}-${mes}-${dia}`;
            console.log(`Fecha convertida: ${input.value}`);
        }
    }
    
    if (fechaDocumentoInput) convertirFecha(fechaDocumentoInput);
    if (fechaVencimientoInput) convertirFecha(fechaVencimientoInput);
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        convertirFechas();
        inicializarTodo();
    });
} else {
    inicializarTodo();
}

function inicializarTodo() {
    // Convertir fechas al formato correcto
    convertirFechas();
    // Inicializar autocompletado de art칤culos primero
    inicializarAutocompletadoArticulos();
}

document.addEventListener('DOMContentLoaded', function() {
    // Funci칩n para configurar el bot칩n eliminar
    function configurarBotonEliminar(row) {
        const removeBtn = row.querySelector('.remove-linea-btn');
        if (removeBtn) {
            // Remover listeners anteriores si existen
            const newBtn = removeBtn.cloneNode(true);
            removeBtn.parentNode.replaceChild(newBtn, removeBtn);
            
            // Agregar nuevo listener
            newBtn.addEventListener('click', function() {
                // Buscar el checkbox DELETE en esta fila
                const deleteField = row.querySelector('input[name*="-DELETE"]');
                if (deleteField) {
                    deleteField.checked = true;
                }
                // Ocultar la fila visualmente
                row.style.display = 'none';
                // Recalcular totales
                actualizarNumerosLinea();
                calcularTotales();
            });
        }
    }
    
    // Calcular todas las l칤neas al cargar
    document.querySelectorAll('.linea-row').forEach(row => {
        calcularLinea(row);
        
        // Configurar bot칩n eliminar
        configurarBotonEliminar(row);
        
        // Event listeners para cambios
        row.querySelector('.cantidad-input')?.addEventListener('input', () => calcularLinea(row));
        row.querySelector('.precio-original-input')?.addEventListener('input', () => calcularLinea(row));
        row.querySelector('.descuento-input')?.addEventListener('input', () => calcularLinea(row));
        row.querySelector('.articulo-select')?.addEventListener('change', () => calcularLinea(row));
    });
    
    // Asegurar que precio_iva_inc siempre sea SI en ventas (no editable)
    const precioIvaIncSelect = document.getElementById('id_precio_iva_inc');
    if (precioIvaIncSelect) {
        // Forzar valor a SI
        precioIvaIncSelect.value = 'SI';
        // Deshabilitar el campo para que no se pueda cambiar
        precioIvaIncSelect.disabled = true;
        precioIvaIncSelect.style.backgroundColor = '#e9ecef';
        precioIvaIncSelect.style.cursor = 'not-allowed';
        // Remover cualquier event listener de change (no debe cambiar nunca)
    }
    
    // Recalcular cuando cambia el tipo de documento (para actualizar IVA seg칰n efactura/factexpo/movcli)
    const tipoDocumentoSelectRecalc = document.getElementById('id_tipo_documento');
    if (tipoDocumentoSelectRecalc) {
        tipoDocumentoSelectRecalc.addEventListener('change', function() {
            document.querySelectorAll('.linea-row').forEach(row => calcularLinea(row));
        });
    }
    
    // Funci칩n para cargar art칤culos en un select
    function cargarArticulosEnSelect(select) {
        if (!select) return;
        // Preservar el valor seleccionado actual (importante para edici칩n)
        const valorActual = select.value;
        select.innerHTML = '<option value="">---------</option>';
        articulosDataList.forEach(articulo => {
            const option = document.createElement('option');
            option.value = articulo.id;
            option.textContent = `${articulo.producto_id || ''} - ${articulo.nombre || ''}`.trim();
            select.appendChild(option);
            // Guardar IVA en cache
            articulosData[articulo.id] = {
                iva_valor: articulo.iva_valor || 0,
                precio_venta: articulo.precio_venta || 0,
                nombre: articulo.nombre || '',
            };
        });
        // Restaurar el valor seleccionado si exist칤a
        if (valorActual) {
            select.value = valorActual;
        }
    }
    
    // Funci칩n para agregar una nueva l칤nea
    function agregarLinea() {
        const tbody = document.getElementById('lineas-tbody');
        const totalForms = parseInt(document.getElementById('id_lineas-TOTAL_FORMS').value);
        const newFormIndex = totalForms;
        
        const newRow = document.createElement('tr');
        newRow.className = 'linea-row';
        newRow.setAttribute('data-form-index', newFormIndex);
        newRow.innerHTML = `
            <td><input type="number" name="lineas-${newFormIndex}-linea" value="${newFormIndex + 1}" class="form-control form-control-sm" readonly style="width: 50px;"></td>
            <td>
                <input type="hidden" name="lineas-${newFormIndex}-id_articulo" id="id_lineas-${newFormIndex}-id_articulo">
                <input type="hidden" name="lineas-${newFormIndex}-id" id="id_lineas-${newFormIndex}-id">
                <input type="checkbox" name="lineas-${newFormIndex}-DELETE" id="id_lineas-${newFormIndex}-DELETE" style="display: none;">
                <div class="autocomplete-container" style="position: relative; display: flex; align-items: center; gap: 3px;">
                    <input type="text" class="form-control form-control-sm articulo-search" placeholder="Presione F2 o click en buscar" autocomplete="off" style="width: 150px;" data-busqueda-mode="nombre" disabled>
                    <button type="button" class="btn btn-sm btn-secondary buscar-articulo-btn" style="padding: 2px 8px; font-size: 0.75rem;" title="Buscar art칤culo (F2)">游댌</button>
                    <button type="button" class="btn btn-sm btn-info toggle-busqueda-btn" style="padding: 2px 6px; font-size: 0.7rem; min-width: 50px;" title="Alternar modo de b칰squeda" data-mode="nombre">Nombre</button>
                    <div class="autocomplete-results articulo-results" style="display: none;"></div>
                </div>
            </td>
            <td><input type="number" name="lineas-${newFormIndex}-cantidad" class="form-control form-control-sm cantidad-input" step="0.01" min="0.01" style="width: 80px;" id="id_lineas-${newFormIndex}-cantidad"></td>
            <td><input type="number" name="lineas-${newFormIndex}-precio_original" class="form-control form-control-sm precio-original-input" step="0.01" min="0" style="width: 100px;" id="id_lineas-${newFormIndex}-precio_original"></td>
            <td><input type="number" name="lineas-${newFormIndex}-descuento" class="form-control form-control-sm descuento-input" step="0.01" min="0" max="100" value="0" style="width: 70px;" id="id_lineas-${newFormIndex}-descuento"></td>
            <td><span class="precio-neto-display">0.00</span></td>
            <td><span class="sub-total-display">0.00</span></td>
            <td><span class="iva-display">0.00</span></td>
            <td><span class="total-display">0.00</span></td>
            <td>
                <button type="button" class="btn btn-sm btn-danger remove-linea-btn">Eliminar</button>
            </td>
        `;
        tbody.appendChild(newRow);
        
        // Inicializar autocompletado de art칤culos para la nueva l칤nea
        // Esperar un poco para asegurar que el DOM est칠 completamente renderizado
        setTimeout(() => {
            inicializarAutocompletadoArticulos();
        }, 100);
        
        // Event listeners
        newRow.querySelector('.cantidad-input').addEventListener('input', () => calcularLinea(newRow));
        newRow.querySelector('.precio-original-input').addEventListener('input', () => calcularLinea(newRow));
        newRow.querySelector('.descuento-input').addEventListener('input', () => calcularLinea(newRow));
        // Configurar bot칩n eliminar para la nueva l칤nea
        configurarBotonEliminar(newRow);
        
        // Actualizar TOTAL_FORMS
        document.getElementById('id_lineas-TOTAL_FORMS').value = newFormIndex + 1;
        formIndex = newFormIndex + 1;
    }
    
    // Funci칩n para actualizar n칰meros de l칤nea
    function actualizarNumerosLinea() {
        let lineaNum = 1;
        document.querySelectorAll('.linea-row').forEach((row) => {
            if (row.style.display !== 'none') {
                const lineaInput = row.querySelector('input[name*="-linea"]');
                if (lineaInput) {
                    lineaInput.value = lineaNum;
                }
                lineaNum++;
            }
        });
    }
    
    // Agregar nueva l칤nea - usar total_form_count del formset
    let formIndex = {{ formset.total_form_count }};
    // Asegurar que formIndex sea al menos 1
    if (formIndex < 1) formIndex = 1;
    
    document.getElementById('add-linea-btn').addEventListener('click', agregarLinea);
    
    // Inicializar autocompletado de art칤culos en l칤neas existentes
    // Esperar un poco para asegurar que el DOM est칠 completamente renderizado
    setTimeout(() => {
        inicializarAutocompletadoArticulos();
    }, 200);
    
    // Configurar el select de plazo
    configurarPlazoSelect();
    
    // Inicializar seg칰n forma de pago (formaPagoSelect ya est치 declarado arriba)
    if (formaPagoSelect && formaPagoSelect.value) {
        formaPagoSelect.dispatchEvent(new Event('change'));
    }
    
    // Manejo de tipo de documento movcli (venta en negro)
    function actualizarMovcli() {
        const precioIvaIncSelect = document.getElementById('id_precio_iva_inc');
        const precioIvaIncHelp = document.getElementById('precio-iva-inc-help');
        
        // Verificar tipo de documento
        const tipoDocSelectMovcli = document.getElementById('id_tipo_documento');
        const tipoDocumentoOption = tipoDocSelectMovcli ? tipoDocSelectMovcli.options[tipoDocSelectMovcli.selectedIndex] : null;
        const tipoDocumentoText = tipoDocumentoOption ? tipoDocumentoOption.text : '';
        const esMovcli = tipoDocumentoText.includes('movcli') || tipoDocumentoText.includes('Movimiento Cliente');
        
        // En ventas, precio_iva_inc siempre es 'SI' (no editable)
        precioIvaIncSelect.value = 'SI';
        precioIvaIncSelect.disabled = true;
        precioIvaIncSelect.style.backgroundColor = '#e9ecef';
        precioIvaIncSelect.style.cursor = 'not-allowed';
        precioIvaIncSelect.style.pointerEvents = 'none';
        
        if (esMovcli) {
            // Movimiento Cliente: IVA incluido (pero IVA = 0 en las l칤neas)
            if (precioIvaIncHelp) {
                precioIvaIncHelp.textContent = 'Movimiento Cliente: IVA incluido (pero IVA = 0 en las l칤neas)';
                precioIvaIncHelp.style.color = '#28a745';
                precioIvaIncHelp.style.display = 'block';
            }
            // Recalcular todas las l칤neas
            document.querySelectorAll('.linea-row').forEach(row => {
                if (row.style.display !== 'none') {
                    calcularLinea(row);
                }
            });
        } else {
            // No es movcli: mostrar ayuda est치ndar
            if (precioIvaIncHelp) {
                precioIvaIncHelp.textContent = 'En ventas, los precios siempre incluyen IVA';
                precioIvaIncHelp.style.color = '#6c757d';
                precioIvaIncHelp.style.display = 'block';
            }
        }
    }
    
    // Cargar opciones de plazo si hay cliente
    const clienteSelect = document.getElementById('id_cliente');
    if (clienteSelect && clienteSelect.value) {
        cargarOpcionesPlazo();
    }
    if (clienteSelect) {
        clienteSelect.addEventListener('change', function() {
            cargarOpcionesPlazo();
        });
    }
    
    // Event listener para tipo de documento (para detectar movcli)
    const tipoDocSelectMovcli2 = document.getElementById('id_tipo_documento');
    if (tipoDocSelectMovcli2) {
        tipoDocSelectMovcli2.addEventListener('change', function() {
            actualizarMovcli();
        });
        // Ejecutar al cargar
        actualizarMovcli();
    }
});
</script>
{% endblock %}

